Kafka 3.6.1 KRaft æ¨¡å¼éƒ¨ç½²æ“ä½œæ‰‹å†Œ

é€‚ç”¨ç‰ˆæœ¬ï¼škafka_2.13-3.6.1.tgz
éƒ¨ç½²æ¨¡å¼ï¼šKRaftï¼ˆæ—  ZooKeeperï¼‰
ç›®æ ‡ç¯å¢ƒï¼šCentOS / Ubuntu Linuxï¼ˆJDK 8+ å·²å®‰è£…ï¼‰
è¯´æ˜ï¼šæœ¬æ‰‹å†Œä»…æä¾›æ“ä½œæµç¨‹ï¼Œå…·ä½“é…ç½®æ–‡ä»¶ç”±æ‚¨æä¾›ï¼Œéƒ¨ç½²æ—¶ç›´æ¥å¤åˆ¶å³å¯ã€‚

ä¸€ã€å‰æœŸå‡†å¤‡
1. ç¡®ä¿å·²å®‰è£… Java
   java -version

äºŒã€å®‰è£… Kafkaï¼ˆæ‰€æœ‰èŠ‚ç‚¹ç»Ÿä¸€æ“ä½œï¼‰
1. ä¸Šä¼ å‹ç¼©åŒ…è‡³ /opt ç›®å½•
   cd /opt
2. è§£å‹å¹¶åˆ›å»ºè½¯é“¾æ¥
   tar -xzf kafka_2.13-3.6.1.tgz
   ln -s kafka_2.13-3.6.1 kafka
3. è¿›å…¥ Kafka ç›®å½•
   cd kafka

ä¸‰ã€é›†ç¾¤åˆå§‹åŒ–ï¼ˆä»…éœ€åœ¨ä¸€å°èŠ‚ç‚¹æ‰§è¡Œï¼‰
1. ç”Ÿæˆé›†ç¾¤ ID
   bin/kafka-storage.sh random-uuid
   ğŸ‘‰ è¯·è®°å½•è¾“å‡ºçš„ UUIDï¼ˆå¦‚ X5jv9QqzR9mYnLkPwZrT1A==ï¼‰

å››ã€é…ç½®æ–‡ä»¶éƒ¨ç½²ï¼ˆå„èŠ‚ç‚¹ç‹¬ç«‹æ“ä½œï¼‰
1. å¤åˆ¶é…ç½®æ–‡ä»¶
   cp /path/to/your/server.properties config/kraft/server.properties

å³ï¼Œå°†æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶è¦†ç›–é»˜è®¤çš„é…ç½®æ–‡ä»¶
æ³¨æ„ï¼š
é…ç½®æ–‡ä»¶é‡Œè¦å¡«å†™é›†ç¾¤idï¼Œå°†åˆšæ‰ç”Ÿæˆçš„é›†ç¾¤idæ›¿æ¢æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶é‡Œé¢çš„id


äº”ã€æ ¼å¼åŒ–å­˜å‚¨ç›®å½•ï¼ˆæ¯å°èŠ‚ç‚¹æ‰§è¡Œï¼‰
CLUSTER_ID="X5jv9QqzR9mYnLkPwZrT1A"
bin/kafka-storage.sh format -t $CLUSTER_ID -c config/kraft/server.properties

å…­ã€å¯åŠ¨ Kafka æœåŠ¡ï¼ˆæ¯å°èŠ‚ç‚¹æ‰§è¡Œï¼‰
æ¨èæ–¹å¼ï¼ˆåå°è¿è¡Œï¼‰ï¼š
nohup bin/kafka-server-start.sh config/kraft/server.properties > kafka.log 2>&1 &

ä¸ƒã€éªŒè¯é›†ç¾¤çŠ¶æ€
1. æŸ¥çœ‹è¿›ç¨‹ï¼šps aux | grep kafka
2. æŸ¥çœ‹ç«¯å£ï¼šss -tulnp | grep ':9092'



ä¹‹åè¿›è¡Œï¼š

åœ¨ä»»æ„ä¸€å°èŠ‚ç‚¹åˆ›å»ºæµ‹è¯• Topic

cd /opt/kafka

# åˆ›å»ºåä¸º "test-topic" çš„ Topicï¼ˆ1 åˆ†åŒºï¼Œå‰¯æœ¬å› å­=1ï¼‰
bin/kafka-topics.sh --create \
  --topic test-topic \
  --partitions 1 \
  --replication-factor 1 \
  --bootstrap-server 192.168.37.130:9092,192.168.37.131:9092,192.168.37.132:9092


é¢„æœŸæˆåŠŸè¾“å‡ºï¼š
Created topic test-topic.




åˆ—å‡ºæ‰€æœ‰ Topicï¼ˆéªŒè¯æ˜¯å¦åˆ›å»ºæˆåŠŸï¼‰
bin/kafka-topics.sh --list \
  --bootstrap-server 192.168.37.130:9092


 é¢„æœŸè¾“å‡ºï¼š
test-topic


ç”Ÿäº§æ¶ˆæ¯ï¼ˆProducer æµ‹è¯•ï¼‰
# å¯åŠ¨æ§åˆ¶å° Producer
bin/kafka-console-producer.sh \
  --topic test-topic \
  --bootstrap-server 192.168.37.130:9092

ç»ˆç«¯ä¼šè¿›å…¥äº¤äº’æ¨¡å¼ï¼Œè¾“å…¥ä»»æ„æ–‡æœ¬å¹¶å›è½¦å³å‘é€ï¼š

>Hello from kafka1!
>This is a test message.





æ¶ˆè´¹æ¶ˆæ¯ï¼ˆConsumer æµ‹è¯•ï¼‰
æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼ˆæˆ– SSH æ–°ä¼šè¯ï¼‰ï¼Œæ‰§è¡Œï¼š
cd /opt/kafka

# ä»å¤´å¼€å§‹æ¶ˆè´¹ test-topic
bin/kafka-console-consumer.sh \
  --topic test-topic \
  --from-beginning \
  --bootstrap-server 192.168.37.130:9092


é¢„æœŸè¾“å‡ºï¼ˆæ˜¾ç¤ºåˆšæ‰å‘é€çš„æ¶ˆæ¯ï¼‰ï¼š
Hello from kafka1!
This is a test message.


ç„¶åä¸‹é¢çš„æ“ä½œï¼š

Kafka 3.6.1 KRaft æ¨¡å¼éƒ¨ç½²æ“ä½œæ‰‹å†Œï¼ˆç¬¬ä¸ƒæ­¥åŠåç»­ï¼‰

é€‚ç”¨ç¯å¢ƒï¼šä¸‰å° CentOS è™šæ‹Ÿæœºï¼ŒIP åˆ†åˆ«ä¸º 192.168.37.130ã€131ã€132
å½“å‰çŠ¶æ€ï¼šKafka å·²å¯åŠ¨ï¼ŒFilebeat é…ç½®ä¸­çš„ Kafka ä¸»é¢˜åä¸º nginx-log

ä¸€ã€ç¡®è®¤ Kafka ä¸­å·²å­˜åœ¨ nginx-log ä¸»é¢˜

1. ç™»å½•ä»»æ„ä¸€å° Kafka èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ kafka1ï¼‰
2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ä¸»é¢˜ï¼š
   cd /opt/kafka
   bin/kafka-topics.sh --list --bootstrap-server 192.168.37.130:9092

3. ç¡®è®¤è¾“å‡ºä¸­åŒ…å«ï¼š
   nginx-log

   å¦‚æœæ²¡æœ‰ï¼Œè¯·å…ˆåˆ›å»ºï¼š
   bin/kafka-topics.sh --create \
     --topic nginx-log \
     --partitions 1 \
     --replication-factor 1 \
     --bootstrap-server 192.168.37.130:9092,192.168.37.131:9092,192.168.37.132:9092

äºŒã€ç¡®ä¿ Filebeat é…ç½®æ­£ç¡®

1. æ£€æŸ¥ /etc/filebeat/filebeat.yml ä¸­çš„ output.kafka éƒ¨åˆ†ï¼š
   output.kafka:
     hosts: ["192.168.37.130:9092", "192.168.37.131:9092", "192.168.37.132:9092"]
     topic: "nginx-log"

   æ³¨æ„ï¼štopic å¿…é¡»æ˜¯ nginx-logï¼ˆä¸å¸¦ sï¼‰

2. é‡å¯ Filebeat ä½¿é…ç½®ç”Ÿæ•ˆï¼š
   systemctl restart filebeat

ä¸‰ã€éªŒè¯æ—¥å¿—æ˜¯å¦æˆåŠŸå‘é€åˆ° Kafka

1. åœ¨ä»»æ„ Kafka èŠ‚ç‚¹ä¸Šå¯åŠ¨æ¶ˆè´¹è€…ï¼Œç›‘å¬ nginx-log ä¸»é¢˜ï¼š
   cd /opt/kafka
   bin/kafka-console-consumer.sh \
     --topic nginx-log \
     --from-beginning \
     --bootstrap-server 192.168.37.130:9092

2. æ­¤æ—¶åº”çœ‹åˆ°ä¸æ–­æœ‰ Nginx è®¿é—®æ—¥å¿—ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œä¾‹å¦‚ï¼š
   {"message":"192.168.37.1 - - [16/Dec/2025:15:00:00 +0800] \"GET / HTTP/1.1\" 200 1234", "host_ip":"192.168.37.130", ...}

3. å¦‚æœçœ‹åˆ°æ—¥å¿—ï¼Œè¯´æ˜æ•´ä¸ªé“¾è·¯ï¼ˆNginx â†’ Filebeat â†’ Kafkaï¼‰å·¥ä½œæ­£å¸¸ã€‚

å››ã€å¸¸è§é—®é¢˜æ’æŸ¥

- å¦‚æœæ¶ˆè´¹è€…çœ‹ä¸åˆ°æ—¥å¿—ï¼š
  1. æ£€æŸ¥ Filebeat æ˜¯å¦è¿è¡Œï¼šsystemctl status filebeat
  2. æŸ¥çœ‹ Filebeat æ—¥å¿—ï¼štail -f /var/log/filebeat/filebeat
  3. ç¡®è®¤ Nginx æ—¥å¿—è·¯å¾„æ˜¯å¦è¢« Filebeat ç›‘æ§ï¼ˆå¦‚ /var/log/nginx/access.logï¼‰
  4. ç¡®è®¤é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œ 9092 ç«¯å£

- å¦‚æœæç¤º "Topic not found"ï¼š
  è¯´æ˜ Kafka ä¸­æ²¡æœ‰ nginx-log ä¸»é¢˜ï¼Œè¯·æŒ‰ç¬¬ä¸€æ­¥åˆ›å»ºã€‚

---
è¯´æ˜ï¼šæœ¬æµç¨‹åŸºäºä½ å½“å‰çš„é…ç½®ï¼ˆä¸»é¢˜åä¸º nginx-logï¼‰ç¼–å†™ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•åç§°ã€‚




èµ°åˆ°è¿™ï¼ŒkafkaåŸºæœ¬æ²¡é—®é¢˜äº†






